<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF å…¥å£ï¼šåˆå§‹åŒ– â†’ å­˜è³‡æ–™ â†’ è·³è½‰ C3</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --bg:#0f172a; --card:#111827; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --muted:#94a3b8; --text:#e5e7eb; }
    html,body { margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto; }
    .wrap { max-width:700px; margin:0 auto; padding:24px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    h1 { margin:0 0 12px; font-size:24px; }
    .steps { list-style:none; padding:0; margin:16px 0; }
    .steps li { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06); }
    .steps li:last-child { border-bottom:0; }
    .badge { width:22px; height:22px; border-radius:50%; display:inline-grid; place-items:center; font-size:12px; }
    .idle { background:#1f2937; color:var(--muted); }
    .doing { background:var(--warn); color:#111; animation:pulse 1s infinite ease-in-out; }
    .done { background:var(--ok); color:#111; }
    .fail { background:var(--err); color:#111; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#93c5fd; }
    .tip { color:var(--muted); font-size:14px; margin-top:12px; }
    .hide { display:none; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:.55} 100%{opacity:1} }
    .foot { margin-top:18px; font-size:12px; color:#9ca3af; }
    button { background:#334155; color:#e5e7eb; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:hover { filter:brightness(1.1); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>LIFF å…¥å£æµç¨‹</h1>
    <div>é€™å€‹é é¢æœƒï¼šåˆå§‹åŒ– LIFF â†’ å–å¾—ä½¿ç”¨è€… â†’ å¯«å…¥ <span class="mono">localStorage</span> â†’ è·³è½‰åˆ° C3 éŠæˆ²ã€‚</div>

    <ul class="steps">
      <li id="s1"><span class="badge idle">1</span> LIFF åˆå§‹åŒ–</li>
      <li id="s2"><span class="badge idle">2</span> å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼ˆæš±ç¨± / userIdï¼‰</li>
      <li id="s3"><span class="badge idle">3</span> å¯«å…¥ <span class="mono">localStorage</span></li>
      <li id="s4"><span class="badge idle">4</span> è·³è½‰åˆ° C3 ç¶²é </li>
    </ul>

    <div class="tip">
      ğŸ”§ <b>è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š</b><br>
      1) LIFF ID åœ¨ä¸‹é¢ç¨‹å¼ç¢¼çš„ <span class="mono">// TODO: YOUR_LIFF_ID</span><br>
      2) C3 ç¶²å€åœ¨ <span class="mono">// TODO: C3_GAME_URL</span>ï¼ˆé è¨­ç”¨åŒç¶²åŸŸçš„ /game-c3/ï¼‰
    </div>

    <div class="tip">
      è‹¥ä½ åœ¨ä¸€èˆ¬ç€è¦½å™¨ç›´æ¥æ‰“é–‹æ¸¬è©¦ï¼ˆé LINE å…§ï¼‰ï¼Œä¹Ÿæœƒå¯«å…¥ <span class="mono">localStorage</span> ä¸¦é€²è¡Œè·³è½‰ï¼Œæ–¹ä¾¿é–‹ç™¼ã€‚
    </div>

    <div class="foot">
      æœ¬é æœƒåœ¨ <span class="mono">localStorage</span> å¯«å…¥éµï¼š<span class="mono">line_name</span>ã€<span class="mono">line_userId</span>ã€<span class="mono">line_picture</span>ã€<span class="mono">from_liff</span>
    </div>

    <div style="margin-top:12px">
      <button id="retryBtn" class="hide">é‡è©¦</button>
    </div>
  </div>
</div>

<script>
  // ====== ä½ è¦æ”¹çš„å…©å€‹åœ°æ–¹ =======================================
  const LIFF_ID = "1657147144-vEBXZmp7";                 // TODO: YOUR_LIFF_ID
  const C3_GAME_URL = "https://onegameonedestiny.github.io/tryline/";      // TODO: C3_GAME_URLï¼ˆå¯å¡«å®Œæ•´ç¶²å€æˆ–åŒç¶²åŸŸç›¸å°è·¯å¾‘ï¼‰
  // ===============================================================

  const s1 = document.querySelector('#s1 .badge');
  const s2 = document.querySelector('#s2 .badge');
  const s3 = document.querySelector('#s3 .badge');
  const s4 = document.querySelector('#s4 .badge');
  const retryBtn = document.getElementById('retryBtn');

  function setState(el, state){
    el.className = 'badge ' + state;
    el.textContent = (state === 'done') ? 'âœ“' : (state === 'fail' ? '!' : el.textContent);
  }

  async function run() {
    try {
      // 1) LIFF åˆå§‹åŒ–
      setState(s1, 'doing');
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        // è§¸ç™¼ç™»å…¥å¾Œæœƒå›åˆ°æœ¬é ï¼Œå†ç¹¼çºŒæµç¨‹
        liff.login({ redirectUri: location.href });
        return;
      }
      setState(s1, 'done');

      // 2) å–å¾—ä½¿ç”¨è€…è³‡æ–™
      setState(s2, 'doing');
      let name = "è¨ªå®¢";
      let userId = "Unknown";
      let picture = "";

      // è‹¥åœ¨ LINE è£¡å°±æŠ“ profileï¼›ä¸åœ¨ LINE ä¹Ÿå…è¨±ç”¨è¨ªå®¢èº«åˆ†ï¼ˆæ–¹ä¾¿é–‹ç™¼æ¸¬è©¦ï¼‰
      if (liff.isInClient() || liff.isLoggedIn()) {
        try {
          const profile = await liff.getProfile();
          name = profile.displayName || name;
          userId = profile.userId || userId;
          picture = profile.pictureUrl || "";
        } catch(e) {
          // å¿½ç•¥éŒ¯èª¤ï¼Œèµ°è¨ªå®¢æµç¨‹
        }
      }
      setState(s2, 'done');

      // 3) å¯«å…¥ localStorage
      setState(s3, 'doing');
      localStorage.setItem("line_name", name);
      localStorage.setItem("line_userId", userId);
      localStorage.setItem("line_picture", picture);
      localStorage.setItem("from_liff", "true");
      setState(s3, 'done');

      // 4) è·³è½‰åˆ° C3
      setState(s4, 'doing');

      // åœ¨ LINE è£¡ç›¡é‡ç•™åœ¨ WebViewï¼ˆexternal:falseï¼‰ï¼Œå¦å‰‡ç”¨ä¸€èˆ¬è·³è½‰
      const targetUrl = new URL(C3_GAME_URL, location.origin).toString();

      if (typeof liff.openWindow === 'function' && (liff.isInClient())) {
        try {
          liff.openWindow({ url: targetUrl, external: false }); // ç•™åœ¨ LINE WebView
        } catch {
          window.location.href = targetUrl; // å¾Œå‚™
        }
      } else {
        window.location.href = targetUrl; // ç€è¦½å™¨æ¸¬è©¦
      }

      setState(s4, 'done');
    } catch (err) {
      console.error(err);
      setState(s1, 'fail'); // å¤šåŠæ˜¯ LIFF IDã€ç™½åå–®æˆ–ç¶²è·¯é€ æˆ
      retryBtn.classList.remove('hide');
    }
  }

  retryBtn.addEventListener('click', () => {
    location.reload();
  });

  // è‡ªå‹•åŸ·è¡Œ
  run();
</script>
</body>
</html>
