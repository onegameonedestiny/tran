<script>
  const LIFF_ID = "1657147144-vEBXZmp7";
  const targetUrl = "/tryline/";

  console.log("🚀 啟動入口頁腳本...");

  const s1 = document.querySelector('#s1 .badge');
  const s2 = document.querySelector('#s2 .badge');
  const s3 = document.querySelector('#s3 .badge');
  const s4 = document.querySelector('#s4 .badge');
  const retryBtn = document.getElementById('retryBtn');

  function setState(el, state){
    el.className = 'badge ' + state;
    el.textContent = (state === 'done') ? '✓' : (state === 'fail' ? '!' : el.textContent);
    console.log("▶️ 狀態變更:", el.parentElement.textContent.trim(), "→", state);
  }

  async function run() {
    console.log("⚙️ 開始 run()");

    try {
      // 初始化 LIFF
      setState(s1, 'doing');
      console.log("⌛ 初始化 LIFF...");
      await liff.init({ liffId: LIFF_ID });
      console.log("✅ LIFF init 完成");

      if (!liff.isLoggedIn()) {
        console.log("🔑 未登入，開始登入");
        liff.login({ redirectUri: location.href });
        return;
      }
      setState(s1, 'done');

      // 取得使用者資料
      setState(s2, 'doing');
      console.log("📡 取得使用者資料中...");
      let name = "訪客";
      let userId = "Unknown";
      let picture = "";

      try {
        const profile = await liff.getProfile();
        name = profile.displayName || name;
        userId = profile.userId || userId;
        picture = profile.pictureUrl || "";
        console.log("✅ 取得 profile:", name, userId);
      } catch (e) {
        console.warn("⚠️ getProfile 失敗，使用訪客模式");
      }
      setState(s2, 'done');

      // 寫入 localStorage
      setState(s3, 'doing');
      console.log("💾 寫入 localStorage...");
      localStorage.setItem("line_name", name);
      localStorage.setItem("line_userId", userId);
      localStorage.setItem("line_picture", picture);
      localStorage.setItem("from_liff", "true");
      setState(s3, 'done');

      // 跳轉
      setState(s4, 'doing');
      console.log("🌐 準備跳轉 →", targetUrl);
      try {
        liff.openWindow({ url: targetUrl, external: false });
      } catch {
        window.location.href = targetUrl;
      }
      setState(s4, 'done');

    } catch (err) {
      console.error("❌ 發生錯誤：", err);
      setState(s1, 'fail');
      retryBtn.classList.remove('hide');
    }
  }

  retryBtn.addEventListener('click', () => location.reload());
  run();
</script>
