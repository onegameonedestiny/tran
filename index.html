<script>
  const LIFF_ID = "1657147144-vEBXZmp7";
  const targetUrl = "/tryline/";

  console.log("ðŸš€ å•Ÿå‹•å…¥å£é è…³æœ¬...");

  const s1 = document.querySelector('#s1 .badge');
  const s2 = document.querySelector('#s2 .badge');
  const s3 = document.querySelector('#s3 .badge');
  const s4 = document.querySelector('#s4 .badge');
  const retryBtn = document.getElementById('retryBtn');

  function setState(el, state){
    el.className = 'badge ' + state;
    el.textContent = (state === 'done') ? 'âœ“' : (state === 'fail' ? '!' : el.textContent);
    console.log("â–¶ï¸ ç‹€æ…‹è®Šæ›´:", el.parentElement.textContent.trim(), "â†’", state);
  }

  async function run() {
    console.log("âš™ï¸ é–‹å§‹ run()");

    try {
      // åˆå§‹åŒ– LIFF
      setState(s1, 'doing');
      console.log("âŒ› åˆå§‹åŒ– LIFF...");
      await liff.init({ liffId: LIFF_ID });
      console.log("âœ… LIFF init å®Œæˆ");

      if (!liff.isLoggedIn()) {
        console.log("ðŸ”‘ æœªç™»å…¥ï¼Œé–‹å§‹ç™»å…¥");
        liff.login({ redirectUri: location.href });
        return;
      }
      setState(s1, 'done');

      // å–å¾—ä½¿ç”¨è€…è³‡æ–™
      setState(s2, 'doing');
      console.log("ðŸ“¡ å–å¾—ä½¿ç”¨è€…è³‡æ–™ä¸­...");
      let name = "è¨ªå®¢";
      let userId = "Unknown";
      let picture = "";

      try {
        const profile = await liff.getProfile();
        name = profile.displayName || name;
        userId = profile.userId || userId;
        picture = profile.pictureUrl || "";
        console.log("âœ… å–å¾— profile:", name, userId);
      } catch (e) {
        console.warn("âš ï¸ getProfile å¤±æ•—ï¼Œä½¿ç”¨è¨ªå®¢æ¨¡å¼");
      }
      setState(s2, 'done');

      // å¯«å…¥ localStorage
      setState(s3, 'doing');
      console.log("ðŸ’¾ å¯«å…¥ localStorage...");
      localStorage.setItem("line_name", name);
      localStorage.setItem("line_userId", userId);
      localStorage.setItem("line_picture", picture);
      localStorage.setItem("from_liff", "true");
      setState(s3, 'done');

      // è·³è½‰
      setState(s4, 'doing');
      console.log("ðŸŒ æº–å‚™è·³è½‰ â†’", targetUrl);
      try {
        liff.openWindow({ url: targetUrl, external: false });
      } catch {
        window.location.href = targetUrl;
      }
      setState(s4, 'done');

    } catch (err) {
      console.error("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
      setState(s1, 'fail');
      retryBtn.classList.remove('hide');
    }
  }

  retryBtn.addEventListener('click', () => location.reload());
  run();
</script>
